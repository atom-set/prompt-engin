---
name: plan-mode
description: Plan 模式行为规范，定义 Plan 模式下的允许和禁止操作
priority: 2
tags: ['core', 'mode', 'plan']
---

# Plan 模式行为规范

## 使用场景

当用户需要：
- Plan 模式下操作时
- 需要分析需求时
- 需要输出方案时

## 触发条件

以下情况自动应用此规范：
- Plan 模式下自动应用
- 分析需求时自动应用

## 与其他规则的配合

- **依赖关系**：
  - `mode-common`：模式切换规则、响应格式规范等通用规则，Plan 模式必须遵循
  - `solution-output`：Plan 模式下，收到代码修改需求时，必须遵循方案输出机制，输出完整的 5 部分方案
- 与核心规则配合使用

---

# Plan 模式行为规范

---

- 默认以Plan模式开始
- 只有在用户明确输入"Act"指令（不区分大小写）后才会切换到Act模式
- Plan模式下允许的操作：
  - 读取和分析文件（read_file）
  - 搜索代码库（codebase_search、grep）
  - 查看目录结构（list_dir）
  - 查看linter错误（read_lints）- 仅查看，不自动修复
  - **运行查询类命令（run_terminal_cmd）** - 仅允许不会改变代码库状态的命令
    - ✅ **允许的命令类型**：
      - 查询类：`git status`、`git log`、`git diff`、`git show`、`ls`、`cat`、`head`、`tail`、`grep`、`find`、`which`、`type`、`pwd`、`whoami`、`date`、`echo`（仅输出）、`wc`、`stat`、`file` 等
      - 检查类：`test`、`[`、`[[`、`command -v`、`which`、`type` 等
      - 信息类：`uname`、`hostname`、`env`、`printenv`、`ps`、`top`、`df`、`du`（仅查询）等
      - 其他只读操作：任何不会修改文件系统、Git 仓库、包管理器状态、环境配置的命令
    - ❌ **禁止的命令类型**：
      - Git 修改类：`git add`、`git commit`、`git push`、`git pull`、`git merge`、`git rebase`、`git reset`、`git checkout`（切换分支）、`git branch`（创建/删除分支）、`git tag`（创建/删除标签）等
      - 文件系统修改类：`mkdir`、`rmdir`、`rm`、`mv`、`cp`（复制到项目外）、`touch`、`chmod`、`chown`、`ln`、`unlink` 等
      - 包管理器类：`npm install`、`npm uninstall`、`npm update`、`yarn add`、`yarn remove`、`pip install`、`pip uninstall`、`composer install`、`composer update` 等
      - 构建和部署类：`npm run build`（如果会修改文件）、`make`（如果会修改文件）、`docker build`、`docker push` 等
      - 环境配置类：`export`（持久化）、`setenv`、修改 `.bashrc`、`.zshrc` 等配置文件
      - 其他可能改变代码库状态的操作
    - ⚠️ **判断原则**：
      - 如果命令可能修改文件系统、Git 仓库、包管理器状态或环境配置，则禁止
      - 如果不确定命令是否会改变代码库状态，应禁止并询问用户
      - 查询类命令必须确保是只读操作，不会产生副作用
  - **创建和管理TODO列表（todo_write）** - 仅用于记录计划，不代表执行许可
    - ✅ 允许：创建TODO列表记录计划任务
    - ❌ 禁止：创建TODO后立即执行代码修改操作
    - ⚠️ 重要：TODO列表只是计划记录，必须等待用户输入"Act"指令后才能执行
  - **添加调试代码**（用于问题定位）：
    - ✅ **允许**：添加临时调试代码用于问题定位
    - ⚠️ **要求**：调试代码应明确标记为临时代码（如使用 `[问题定位]` 前缀）
    - ⚠️ **要求**：调试代码应使用 `console.info` 或 `logger.info` 输出调试信息
    - ⚠️ **要求**：修复完成后，应清理临时调试代码
    - ❌ **禁止**：将调试代码作为永久修复方案
    - ❌ **禁止**：在未定位问题的情况下添加防御性代码

#### 执行意图确认机制

- **重要原则**：
  - 创建TODO列表后，不能立即执行代码修改
  - 必须明确等待用户输入"Act"指令
  - 如果用户没有输入"Act"指令，即使创建了TODO列表，也不能执行任何代码修改操作
- **在Plan模式下，只能**：
  1. 创建计划（TODO列表）
  2. 输出计划内容
  3. 分析代码和问题
  4. 等待用户确认（输入"Act"）

- **Plan 模式禁止的操作**：
  - 详细的禁止工具清单和检查机制，请参考 `tool-permission-system.md`（工具权限系统）
  - **重要原则**：
    - 任何可能改变代码库状态的操作都必须禁止
    - 只有用户明确输入"Act"指令后，才能切换到Act模式执行这些操作
- 重要区分：输出计划 vs 创建文件
  - Plan模式的核心是"输出计划内容"，而不是"创建文件"
  - ✅ 输出计划内容：在对话中展示计划、任务清单、分析结果等（这是Plan模式的核心功能）
  - ❌ 创建文件：使用write工具实际写入文件系统（完全禁止，如需创建文件需切换到Act模式）
- Plan模式下处理用户要求创建文件的流程：
  1. 如果用户要求"放到新文件里"、"保存到文件"、"创建文件"等：
     - 先在对话中输出完整内容
     - 然后提醒："当前处于Plan模式，如需创建文件保存，请输入'Act'切换到执行模式"
     - 或者询问："是否需要我切换到执行模式创建文件？"
  2. 如果用户没有明确要求创建文件，但内容较长，可以询问："是否需要将内容保存到文件？如需保存，请输入'Act'切换到执行模式"

- Plan模式输出规范：
  - **输出前确认机制**：
    1. 如果输出内容较长（>500字），先说明要输出什么，询问用户是否需要完整输出，还是先输出概览
    2. 如果用户明确要求输出（如"输出方案"、"列出节点"、"展示计划"等），可以直接输出
    3. 如果用户要求"放到新文件里"、"保存到文件"等，应先在对话中输出完整内容，然后提醒需要切换到Act模式才能创建文件
    4. 如果用户没有明确要求输出详细内容，先输出概览或摘要，再询问是否需要完整内容
  - **输出内容分类**：
    1. **计划内容**：任务清单、工作安排、下一步计划等（建议<500字，可直接输出）
    2. **分析结果**：数据分析、问题识别、建议等（建议<500字，可直接输出；超过500字先输出摘要）
    3. **完整文档**：详细的技术方案、设计文档等（建议创建文件保存，或在对话中分段输出）
  - **输出方式优先级**：
    1. 优先满足用户明确要求（如"输出方案"、"列出节点"等）
    2. 如果内容较长，先输出概览或摘要，询问用户是否需要完整内容
    3. 如果用户要求保存到文件，先在对话中输出完整内容，然后提醒需要切换到Act模式才能创建文件
    4. 在满足用户要求后，再输出更新后的计划（用分隔线区分）

### 使用场景示例

#### 示例1：分析需求并输出方案

**场景**：用户描述了一个功能需求，需要修改代码

**执行流程**：
```
1. 分析用户需求，理解要解决的问题
2. 搜索相关代码，了解现有实现
3. 输出详细方案（5个部分）：
   - 需求分析
   - 修改方案
   - 影响分析
   - 实施计划（任务清单表格）
   - 风险评估
4. 输出更新后的计划
5. 提醒："当前处于Plan模式，如需执行修改，请输入'Act'切换到执行模式"
```

#### 示例2：用户要求创建文件

**场景**：用户要求"将内容保存到文件"

**执行流程**：
```
1. 先在对话中输出完整内容
2. 提醒："当前处于Plan模式，如需创建文件保存，请输入'Act'切换到执行模式"
3. 或者询问："是否需要我切换到执行模式创建文件？"
```

#### 示例3：用户询问问题

**场景**：用户询问"如何实现某个功能"

**执行流程**：
```
1. 识别为询问，不是修改需求
2. 提供解答，说明实现方法
3. 不输出方案，不切换到 Act 模式
```