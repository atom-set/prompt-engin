# 代码修改前的方案输出机制

> **文件说明**：本文件包含代码修改前的方案输出机制
> **规则来源**：rules/stages/common/mode/plan/solution-output.md

---

- **核心原则**：在 Plan 模式下，收到任何代码修改需求时，必须先输出详细的修改方案和计划，等待用户确认后才能执行
- **意图识别机制**：
  - **必须区分用户意图**：
    - **问题描述**：用户描述问题、现象或需求（如"XXX 不工作"、"XXX 无法跳转"、"需要修复 XXX"）
    - **明确修改需求**：用户明确要求修改（如"修改 XXX"、"实现 XXX"、"添加 XXX"）
  - **触发方案输出的条件**（满足任一条件即必须输出方案）：
    - ✅ 用户明确要求修改代码
    - ✅ 用户描述问题但可能涉及代码修改（如"XXX 不工作"、"XXX 无法跳转"、"需要修复 XXX"）
    - ✅ 用户描述功能需求但需要代码实现
    - ✅ 任何可能调用文件修改工具的情况
  - **禁止的行为**：参考"禁止行为清单"章节
- **修改需求判断标准**（新增）：
  - **关键词列表**：
    - 动作词：创建、修改、添加、删除、实现、修复、更新、替换、编写、生成等
    - 功能词：需要、要求、希望、应该、必须等
  - **上下文判断**（新增）：
    - 不仅看关键词，还要分析上下文语境
    - 检查关键词前后的语境，判断是修改需求还是询问
    - 例如："生成一个通用的提示词"可能是询问（如何生成），也可能是修改需求（请生成）
  - **不确定时的确认机制**（新增）：
    - 如果判断不确定，应先询问用户意图，而不是直接假设
    - 使用清晰、明确的问题表述，提供明确的选项
    - 等待用户明确回复后再决定是否输出方案
  - **判断流程图**：
    ```
    用户输入 → 关键词匹配 → 上下文分析 → 判断类型 → 执行对应流程
    如果判断不确定 → 询问用户意图 → 等待明确回复 → 执行对应流程
    ```
  - **示例场景**：
    - "创建文件" → 修改需求 → 输出方案
    - "如何创建文件" → 询问 → 提供解答
    - "需要创建文件" → 修改需求 → 输出方案
    - "生成一个通用的提示词" → 不确定 → 询问："您希望我生成一个通用的提示词模板吗？还是只是想了解如何生成？"
- **意图不明确时的确认机制**：
  - **判断标准**：
    - 用户描述模糊，无法明确判断是问题描述还是修改需求
    - 用户描述可能涉及代码修改，但意图不明确
    - 用户描述可能只是询问，不涉及代码修改
    - 用户使用了模糊的表述（如"这个"、"那个"、"能不能"等），无法确定具体需求
  - **确认流程**：
    1. **识别意图不明确的情况**：
       - 分析用户描述，判断是否存在意图不明确的情况
       - 如果存在，进入确认流程
    2. **明确询问用户意图**：
       - 使用清晰、明确的问题表述
       - 提供明确的选项（是/否、修改/不修改等）
       - 必要时提供示例说明
    3. **等待用户明确回复**：
       - 必须等待用户明确回复后再继续
       - 不能假设用户意图
       - 如果用户未明确回复，应再次询问或提供更详细的说明
    4. **根据用户回复决定下一步行动**：
       - 如果用户明确要求修改，进入方案输出流程
       - 如果用户只是询问，提供解答，不执行修改
       - 如果用户取消，停止当前流程
  - **询问格式要求**：
    - 使用清晰、明确的问题表述
    - 提供明确的选项（是/否、修改/不修改、实现/不实现等）
    - 必要时提供示例说明，帮助用户理解问题
    - 避免使用模糊表述（如"这个"、"那个"等）
  - **禁止的行为**：参考"禁止行为清单"章节
  - **示例场景**：
    - **场景1：用户描述问题，但未明确要求修改**
      ```
      用户：这个功能不工作
      AI（Plan模式）：
        识别：用户描述问题，但未明确要求修改
        询问："您希望我修复这个问题吗？还是只是想了解问题原因？"
        等待用户回复
      ```
    - **场景2：用户描述功能需求，但未明确要求实现**
      ```
      用户：能不能添加一个登录功能
      AI（Plan模式）：
        识别：用户描述功能需求，但使用了"能不能"这样的模糊表述
        询问："您希望我现在实现登录功能吗？还是只是想了解实现方案？"
        等待用户回复
      ```
    - **场景3：用户描述可能涉及代码修改，但意图不明确**
      ```
      用户：这个按钮点击没反应
      AI（Plan模式）：
        识别：用户描述问题，可能涉及代码修改，但意图不明确
        询问："您希望我检查并修复这个问题吗？还是只是想了解可能的原因？"
        等待用户回复
      ```
- **强制要求**：
  1. **必须先输出方案**：
     - 收到代码修改需求或问题描述（可能涉及代码修改）时，必须先分析需求
     - 输出详细的修改方案（包括：修改内容、影响范围、实施步骤等）
     - 输出完整的任务清单（使用表格格式）
     - 说明修改的风险和注意事项
     - **方案输出时机要求**（新增）：方案输出必须在调用修改工具前的**同一响应中**完成
     - **禁止跨响应执行**（新增）：如果先调用了只读工具，必须在同一响应中输出完整方案，不能跨响应直接调用修改工具
  2. **必须输出计划**：
     - 在方案输出后，必须输出更新后的计划
     - 计划应包含任务清单、优先级、预计影响等
     - 使用分隔线区分方案和计划
  3. **必须等待确认**：
     - 输出方案和计划后，必须明确提醒用户输入"Act"指令才能执行
     - 不能假设用户同意执行
     - 不能跳过方案输出直接执行修改
     - **执行顺序要求**（新增）：方案输出 → 等待用户输入"Act" → 切换到 Act 模式 → 调用工具
     - **禁止跨响应调用**（新增）：如果输出了方案，必须等待用户明确输入"Act"后才能调用工具，不能在下一个响应中直接调用工具
- **方案输出内容要求**：
  1. **需求分析**：分析用户需求，明确要解决的问题
  2. **修改方案**：详细的修改方案，包括：
     - 修改的文件和位置
     - 具体的修改内容
     - 修改的原因和目的
     - **设计原则**（强制要求，参考 `design-principles.md`）：
       - **优先考虑简单方案**：必须首先提出最简单的实现方案
       - **避免过度设计**：不要为了"未来可能的需求"而增加不必要的复杂度
       - **复杂方案需明确场景**：如果采用复杂方案，必须明确说明：
         - 在什么具体场景下需要复杂方案？
         - 简单方案为什么无法满足需求？
         - 有哪些明确的约束条件？
       - **方案对比**：必须对比简单方案和复杂方案，说明各自的优缺点和选择理由
       - **禁止假设未来需求**：不能因为"未来可能需要"而采用复杂方案
  3. **影响分析**：分析修改可能的影响：
     - 对现有功能的影响
     - 对相关文件的影响
     - 是否需要向下兼容
  4. **实施计划**：详细的实施步骤：
     - 任务清单（使用表格格式）
     - 实施顺序
     - 注意事项
  5. **风险评估**：评估修改的风险：
     - 潜在问题
     - 回滚方案
- **方案完整性检查**：
  - 方案必须包含以上所有5个部分（需求分析、修改方案、影响分析、实施计划、风险评估）
  - 任务清单必须使用表格格式，包含任务编号、任务名称、状态、优先级、说明等列
  - 如果方案不完整，必须补充完整后才能执行
  - 在 Act 模式下执行前，必须验证当前执行的修改与方案一致
  - 如果发现方案遗漏重要内容，必须停止执行，返回 Plan 模式补充方案
- **正确流程**：
  1. 收到代码修改需求
  2. 分析需求，理解要解决的问题
  3. 输出详细的修改方案（包括需求分析、修改方案、影响分析、实施计划、风险评估）
  4. 输出更新后的计划（任务清单）
  5. 明确提醒用户输入"Act"指令才能执行
  6. 等待用户输入"Act"指令
  7. 用户输入"Act"后，切换到 Act 模式执行修改
- **示例流程**：
  ```
  用户：修改某个功能
  AI（Plan模式）：
    1. 分析需求
    2. 输出详细方案（需求分析、修改方案、影响分析、实施计划、风险评估）
    3. 输出任务清单
    4. 提醒："当前处于Plan模式，如需执行修改，请输入'Act'切换到执行模式"
  用户：Act
  AI（Act模式）：
    执行代码修改
  ```
- **问题描述场景示例**：
  ```
  用户：按住点击 wx_login_redirect 不会进入定义的文件
  AI（Plan模式）：
    1. 识别意图：这是问题描述，可能涉及代码修改（修复 IDE 跳转问题）
    2. 分析需求：需要修改枚举定义方式，让 IDE 能够识别属性引用
    3. 输出详细方案（需求分析、修改方案、影响分析、实施计划、风险评估）
    4. 输出任务清单
    5. 提醒："当前处于Plan模式，如需执行修改，请输入'Act'切换到执行模式"
  用户：Act
  AI（Act模式）：
    执行代码修改
  ```
- **错误示例（禁止的行为）**：
  ```
  用户：按住点击 wx_login_redirect 不会进入定义的文件
  AI（Plan模式）：
    ❌ 错误：直接执行代码修改，没有输出方案
    ❌ 错误：假设用户描述问题就是要求修改
    ❌ 错误：跳过方案输出直接调用 search_replace
  ```

