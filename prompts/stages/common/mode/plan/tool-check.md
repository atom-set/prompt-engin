# 工具调用前的统一检查机制

> **文件说明**：本文件包含工具调用前的统一检查机制
> **规则来源**：rules/stages/common/mode/plan/tool-check.md

---

- **检查时机**：在调用任何工具前必须执行此检查机制

- **模式说明**：
  - **Plan/Act 模式**：决定工具调用权限的主要模式
    - Plan 模式：禁止调用文件修改工具
    - Act 模式：允许调用文件修改工具（需满足方案完整性要求）
  - **Debug 模式**：辅助模式，不影响工具调用权限
    - Debug 模式可以与 Plan/Act 模式并行使用
    - Debug 模式只影响响应格式（显示 `[Debug]` 标识）和 Debug 功能执行
    - **重要**：工具调用检查只考虑 Plan/Act 模式，不考虑 Debug 模式状态

- **检查步骤**（按顺序执行，不能跳过任何步骤）：

  0. **第零步：方案输出前置检查**（新增）
     - **检查条件**：如果用户有修改需求（明确要求修改、描述问题可能涉及修改、功能需求需要实现等）
     - **检查内容**：
       - 是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
       - 是否已输出任务清单（使用表格格式）
     - **检查结果**：
       - 如果用户有修改需求但未输出方案：**禁止调用任何工具**，必须先输出方案
       - 如果用户没有修改需求：进入第一步（模式检查）
       - 如果已输出方案：进入第一步（模式检查）
     - **重要原则**：
       - Plan 模式下，如果用户有修改需求，必须先输出方案，不能直接调用任何工具
       - 即使工具本身是允许的（如 read_file），如果涉及修改需求，也必须先输出方案
       - 此检查优先于模式检查，确保方案输出是工具调用的前置条件

  1. **第一步：模式检查**
     - 确认当前主模式（Plan 或 Act）
     - **注意**：只检查 Plan/Act 模式，不检查 Debug 模式（Debug 模式不影响工具调用权限）
     - 如果当前是 Plan 模式，进入第二步
     - 如果当前是 Act 模式，进入第三步

  2. **第二步：Plan 模式检查**
     - 检查工具类型（是否为禁止的工具）
     - **禁止的工具清单**（Plan 模式）：
       - search_replace（修改文件）
       - write（创建或修改文件）
       - delete_file（删除文件）
       - edit_notebook（编辑笔记本）
       - run_terminal_cmd（运行可能改变代码库的命令，详见上面的命令类型分类）
     - **检查结果**：
       - 如果是禁止的工具：**禁止调用**，立即停止并提醒用户需要切换到 Act 模式
       - 如果是允许的工具：可以调用

  3. **第三步：Act 模式检查**
     - 检查是否为文件修改工具（search_replace、write、delete_file、edit_notebook）
     - 如果是文件修改工具，进入第四步（方案完整性检查）
     - 如果不是文件修改工具，可以调用

  4. **第四步：方案完整性检查**（仅针对文件修改工具）
     - 检查是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
     - 检查是否已输出任务清单（使用表格格式）
     - 检查用户是否已输入 "Act" 指令
     - **检查结果**：
       - 如果方案不完整：停止执行并返回 Plan 模式补充方案
       - 如果方案完整：可以调用

- **检查清单**（调用工具前必须逐项检查）：
  - [ ] 如果用户有修改需求，已检查是否已输出完整方案（第零步）
  - [ ] 已确认当前主模式（Plan 或 Act，不考虑 Debug 模式）
  - [ ] 已确认要调用的工具类型
  - [ ] 如果是 Plan 模式，已检查是否为禁止的工具
  - [ ] 如果是 Act 模式且是文件修改工具，已检查方案完整性
  - [ ] 已确认满足所有检查条件
  - **注意**：Debug 模式状态不影响此检查清单

- **禁止的行为**：
  - ❌ 在 Plan 模式下调用文件修改工具
  - ❌ 在 Act 模式下但方案不完整时执行修改
  - ❌ 跳过检查直接调用工具
  - ❌ 跳过任何检查步骤
  - ❌ 未输出方案就调用工具（即使工具本身是允许的）
    - 如果用户有修改需求，必须先输出方案，才能调用任何工具
    - 即使工具本身是允许的（如 read_file），如果涉及修改需求，也必须先输出方案

- **错误处理**：
  - 如果误调用禁止的工具，应立即停止并提醒用户需要切换到 Act 模式
  - 如果方案不完整，应停止执行并返回 Plan 模式补充方案

