# 工具调用前的统一检查机制

> **文件说明**：本文件包含工具调用前的统一检查机制
> **规则来源**：rules/stages/common/mode/plan/tool-check.md

---

- **检查时机**：在调用任何工具前必须执行此检查机制

- **模式说明**：
  - **Plan/Act 模式**：决定工具调用权限的主要模式
    - Plan 模式：禁止调用文件修改工具
    - Act 模式：允许调用文件修改工具（需满足方案完整性要求）
  - **Debug 模式**：辅助模式，不影响工具调用权限
    - Debug 模式可以与 Plan/Act 模式并行使用
    - Debug 模式只影响响应格式（显示 `[Debug]` 标识）和 Debug 功能执行
    - **重要**：工具调用检查只考虑 Plan/Act 模式，不考虑 Debug 模式状态

- **检查步骤**（按顺序执行，不能跳过任何步骤）：

  0. **第零步：方案输出前置检查**（新增）
     - **检查条件**：如果用户有修改需求（明确要求修改、描述问题可能涉及修改、功能需求需要实现等）
     - **检查内容**：
       - 是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
       - 是否已输出任务清单（使用表格格式）
       - **方案输出时机**：方案输出必须在调用修改工具前的**同一响应中**完成
       - **跨响应检查**：禁止在输出方案后的下一个响应中直接调用工具（未等待用户输入"Act"）
     - **检查结果**：
       - 如果用户有修改需求但未输出方案：
         - ✅ **允许调用只读工具**（read_file、grep、codebase_search、list_dir、read_lints）来理解问题和代码结构
         - ❌ **禁止调用修改工具**（search_replace、write、delete_file、edit_notebook）
         - ⚠️ **必须先输出方案**，才能调用修改工具
         - ⚠️ **如果先调用了只读工具，必须在同一响应中输出方案**，不能跨响应直接调用修改工具
       - 如果用户没有修改需求：进入第一步（模式检查）
       - 如果已输出方案：进入第一步（模式检查）
     - **重要原则**：
       - Plan 模式下，如果用户有修改需求：
         - ✅ 可以先调用只读工具理解问题，确保方案准确性
         - ❌ 禁止直接调用修改工具，必须先输出方案
         - ⚠️ 方案输出是修改工具调用的前置条件，但不是只读工具调用的前置条件
         - ⚠️ **方案输出时机要求**：如果先调用了只读工具，必须在同一响应中输出完整方案，不能跨响应直接调用修改工具
         - ⚠️ **执行顺序要求**：方案输出 → 等待用户输入"Act" → 切换到 Act 模式 → 调用工具
       - 此检查优先于模式检查，确保方案输出是修改工具调用的前置条件

  1. **第一步：模式检查**
     - 确认当前主模式（Plan 或 Act）
     - **注意**：只检查 Plan/Act 模式，不检查 Debug 模式（Debug 模式不影响工具调用权限）
     - 如果当前是 Plan 模式，进入第二步
     - 如果当前是 Act 模式，进入第三步

  2. **第二步：Plan 模式检查**
     - 检查工具类型（是否为禁止的工具）
     - **禁止的工具清单**（Plan 模式）：
       - search_replace（修改文件）
       - write（创建或修改文件）
       - delete_file（删除文件）
       - edit_notebook（编辑笔记本）
       - run_terminal_cmd（运行可能改变代码库的命令，详见上面的命令类型分类）
     - **检查结果**：
       - 如果是禁止的工具：**禁止调用**，立即停止并提醒用户需要切换到 Act 模式
       - 如果是允许的工具：可以调用

  3. **第三步：Act 模式检查**
     - 检查是否为文件修改工具（search_replace、write、delete_file、edit_notebook）
     - 如果是文件修改工具，进入第四步（方案完整性检查）
     - 如果不是文件修改工具，可以调用

  4. **第四步：方案完整性检查**（仅针对文件修改工具）
     - 检查是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
     - 检查是否已输出任务清单（使用表格格式）
     - 检查用户是否已输入 "Act" 指令
     - **检查结果**：
       - 如果方案不完整：停止执行并返回 Plan 模式补充方案
       - 如果方案完整：可以调用

- **检查清单**（调用工具前必须逐项检查）：
  - [ ] 如果用户有修改需求：
    - [ ] 如果要调用修改工具，已检查是否已输出完整方案（第零步）
    - [ ] 如果要调用只读工具，允许调用（用于理解问题）
  - [ ] 已确认当前主模式（Plan 或 Act，不考虑 Debug 模式）
  - [ ] 已确认要调用的工具类型（只读工具 or 修改工具）
  - [ ] 如果是 Plan 模式，已检查是否为禁止的工具
  - [ ] 如果是 Act 模式且是文件修改工具，已检查方案完整性
  - [ ] 已确认满足所有检查条件
  - **注意**：Debug 模式状态不影响此检查清单

- **禁止的行为**：
  - ❌ 在 Plan 模式下调用文件修改工具
  - ❌ 在 Act 模式下但方案不完整时执行修改
  - ❌ 跳过检查直接调用工具
  - ❌ 跳过任何检查步骤
  - ❌ 未输出方案就调用修改工具（如果用户有修改需求）
    - 如果用户有修改需求，必须先输出方案，才能调用修改工具（search_replace、write、delete_file、edit_notebook）
    - ✅ 允许先调用只读工具（read_file、grep、codebase_search）理解问题，再输出方案
    - ❌ 禁止在未输出方案的情况下，直接调用修改工具执行修改操作

- **错误处理**：
  - 如果误调用禁止的工具，应立即停止并提醒用户需要切换到 Act 模式
  - 如果方案不完整，应停止执行并返回 Plan 模式补充方案

- **强制检查机制**（新增）：
  - **执行要求**：在调用任何工具前，必须逐项执行所有检查步骤，不能跳过任何步骤
  - **验证机制**：在工具调用前，必须**显式输出检查结果**，确认已执行所有检查
  - **拦截机制**：如果检测到未输出检查结果就调用工具，应**拒绝执行**并提醒："⚠️ 检测到未执行检查步骤，请先完成所有检查后再调用工具"
  - **检查日志**：记录每次工具调用前的检查结果，便于追踪和调试
  - **禁止行为**：
    - ❌ 禁止跳过任何检查步骤
    - ❌ 禁止在检查不完整时调用工具
    - ❌ 禁止假设检查已执行
    - ❌ 禁止在未显式输出检查结果的情况下调用工具

- **触发条件判断**（新增）：
  - **明确修改需求的关键词**：
    - 动作词：创建、修改、添加、删除、实现、修复、更新、替换等
    - 功能词：需要、要求、希望、应该等
  - **明确询问的关键词**：
    - 疑问词：如何、为什么、是什么、能否、是否等
    - 询问词：了解、说明、解释、查看等
  - **上下文判断**（新增）：
    - 不仅看关键词，还要分析上下文语境
    - 检查关键词前后的语境，判断是修改需求还是询问
    - 例如："生成一个通用的提示词"可能是询问（如何生成），也可能是修改需求（请生成）
  - **不确定时的确认机制**（新增）：
    - 如果判断不确定，应先询问用户意图，而不是直接假设
    - 使用清晰、明确的问题表述，提供明确的选项
    - 等待用户明确回复后再决定是否输出方案
  - **判断流程**：
    1. 检查用户输入是否包含修改需求关键词
    2. 如果包含，**分析上下文**，判断是否为修改需求
    3. 如果判断不确定，**先询问用户意图**，等待明确回复
    4. 如果明确为修改需求，触发方案输出
    5. 如果不包含修改需求关键词，检查是否包含询问关键词
    6. 如果包含询问关键词，判断为询问，不触发方案输出
    7. 如果都不包含，询问用户意图

