# 安全规则和权限规则

> **文件说明**：本文件系统化整理 AI 的安全规则和权限规则，明确哪些可以做、哪些不可以做、哪些需要确认
> **创建时间**：2025-12-12（本地时间）
> **规则来源**：整合自 `plan-mode.md`、`act-mode.md`、`mode-common.md`、`debug-mode.md` 等文件

---

## 📑 目录导航

- [一、总则](#一总则)
- [二、模式权限矩阵](#二模式权限矩阵)
- [三、工具权限分类](#三工具权限分类)
  - [3.1 可以做](#31-可以做)
  - [3.2 不可以做](#32-不可以做)
  - [3.3 需要确认](#33-需要确认)
- [四、行为权限分类](#四行为权限分类)
  - [4.1 可以做](#41-可以做)
  - [4.2 不可以做](#42-不可以做)
  - [4.3 需要确认](#43-需要确认)
- [五、安全检查机制](#五安全检查机制)
- [六、权限升级机制](#六权限升级机制)

---

## 一、总则

### 核心原则

- **安全第一**：所有操作必须以安全为前提，禁止执行可能造成损害的操作
- **权限明确**：每个模式下的权限必须明确，不能模糊或假设
- **确认优先**：对于需要确认的操作，必须等待用户明确确认后才能执行
- **检查强制**：所有工具调用前必须执行安全检查，不能跳过

### 适用范围

- **所有模式**：Plan 模式、Act 模式、Debug 模式
- **所有工具**：文件操作工具、代码搜索工具、终端命令等
- **所有行为**：代码修改、文件创建、命令执行等

### 规则关系

本文件是对以下规则文件的整合和索引：

- `plan-mode.md`：Plan 模式的详细行为规范
- `act-mode.md`：Act 模式的详细行为规范
- `mode-common.md`：模式切换和通用规则
- `debug-mode.md`：Debug 模式的详细规范

**重要说明**：
- 本文件提供权限规则的快速参考和系统化整理
- 详细的行为规范请参考对应的规则文件
- 如果本文件与详细规则文件有冲突，以详细规则文件为准

---

## 二、模式权限矩阵

### 权限对比表

| 操作类型 | Plan 模式 | Act 模式 | Debug 模式 | 说明 |
|---------|----------|---------|-----------|------|
| **文件读取** | ✅ 允许 | ✅ 允许 | ✅ 允许 | 所有模式都允许读取文件 |
| **代码搜索** | ✅ 允许 | ✅ 允许 | ✅ 允许 | 所有模式都允许搜索代码库 |
| **查看目录** | ✅ 允许 | ✅ 允许 | ✅ 允许 | 所有模式都允许查看目录结构 |
| **查看 Linter 错误** | ✅ 允许（仅查看） | ✅ 允许（仅查看） | ✅ 允许（仅查看） | 所有模式都允许查看，但不自动修复 |
| **运行查询命令** | ✅ 允许（只读） | ✅ 允许（只读） | ✅ 允许（只读） | 仅允许不会改变代码库状态的命令 |
| **创建 TODO 列表** | ✅ 允许 | ✅ 允许 | ✅ 允许 | 仅用于记录计划，不代表执行许可 |
| **添加调试代码** | ✅ 允许（临时） | ✅ 允许（临时） | ✅ 允许（临时） | 用于问题定位，修复后需清理 |
| **修改文件** | ❌ 禁止 | ⚠️ 需要确认 | ❌ 禁止 | Act 模式需要方案完整且用户输入 "Act" |
| **创建文件** | ❌ 禁止 | ⚠️ 需要确认 | ❌ 禁止 | Act 模式需要方案完整且用户输入 "Act" |
| **删除文件** | ❌ 禁止 | ⚠️ 需要确认 | ❌ 禁止 | Act 模式需要方案完整且用户输入 "Act" |
| **运行修改命令** | ❌ 禁止 | ⚠️ 需要确认 | ❌ 禁止 | Act 模式需要方案完整且用户输入 "Act" |
| **Git 操作** | ❌ 禁止 | ❌ 禁止 | ❌ 禁止 | 所有模式都禁止 Git 操作 |
| **包管理器操作** | ❌ 禁止 | ❌ 禁止 | ❌ 禁止 | 所有模式都禁止包管理器操作 |
| **环境配置修改** | ❌ 禁止 | ❌ 禁止 | ❌ 禁止 | 所有模式都禁止环境配置修改 |

### 模式说明

#### Plan 模式

- **默认模式**：系统默认以 Plan 模式开始
- **权限特点**：只读操作，禁止任何修改操作
- **主要用途**：分析需求、制定计划、输出方案

#### Act 模式

- **进入条件**：用户明确输入 "Act" 指令（不区分大小写）
- **权限特点**：允许修改操作，但需要方案完整且用户确认
- **主要用途**：执行代码修改、创建文件、删除文件等

#### Debug 模式

- **模式性质**：辅助模式，可以与 Plan/Act 模式并行使用
- **权限特点**：不影响工具调用权限，只影响响应格式和 Debug 功能
- **主要用途**：规则检查、提示词归档、会话管理

---

## 三、工具权限分类

### 3.1 可以做

#### 文件操作工具

| 工具 | Plan 模式 | Act 模式 | 说明 |
|------|----------|---------|------|
| `read_file` | ✅ 允许 | ✅ 允许 | 读取文件内容 |
| `list_dir` | ✅ 允许 | ✅ 允许 | 查看目录结构 |
| `glob_file_search` | ✅ 允许 | ✅ 允许 | 搜索文件 |

#### 代码搜索工具

| 工具 | Plan 模式 | Act 模式 | 说明 |
|------|----------|---------|------|
| `codebase_search` | ✅ 允许 | ✅ 允许 | 语义搜索代码库 |
| `grep` | ✅ 允许 | ✅ 允许 | 文本搜索代码库 |

#### 代码分析工具

| 工具 | Plan 模式 | Act 模式 | 说明 |
|------|----------|---------|------|
| `read_lints` | ✅ 允许（仅查看） | ✅ 允许（仅查看） | 查看 Linter 错误，不自动修复 |

#### 终端命令工具

| 命令类型 | Plan 模式 | Act 模式 | 说明 |
|---------|----------|---------|------|
| 查询类命令 | ✅ 允许 | ✅ 允许 | `git status`、`git log`、`git diff`、`git show`、`ls`、`cat`、`head`、`tail`、`grep`、`find`、`which`、`type`、`pwd`、`whoami`、`date`、`echo`（仅输出）、`wc`、`stat`、`file` 等 |
| 检查类命令 | ✅ 允许 | ✅ 允许 | `test`、`[`、`[[`、`command -v`、`which`、`type` 等 |
| 信息类命令 | ✅ 允许 | ✅ 允许 | `uname`、`hostname`、`env`、`printenv`、`ps`、`top`、`df`、`du`（仅查询）等 |

#### 计划管理工具

| 工具 | Plan 模式 | Act 模式 | 说明 |
|------|----------|---------|------|
| `todo_write` | ✅ 允许 | ✅ 允许 | 创建和管理 TODO 列表（仅用于记录计划，不代表执行许可） |

### 3.2 不可以做

#### 文件修改工具（Plan 模式禁止）

| 工具 | Plan 模式 | Act 模式 | 说明 |
|------|----------|---------|------|
| `search_replace` | ❌ 禁止 | ⚠️ 需要确认 | 修改现有文件 |
| `write` | ❌ 禁止 | ⚠️ 需要确认 | 创建新文件或修改现有文件 |
| `delete_file` | ❌ 禁止 | ⚠️ 需要确认 | 删除文件 |
| `edit_notebook` | ❌ 禁止 | ⚠️ 需要确认 | 编辑笔记本 |

#### 终端命令（所有模式禁止）

| 命令类型 | Plan 模式 | Act 模式 | 说明 |
|---------|----------|---------|------|
| Git 修改类 | ❌ 禁止 | ❌ 禁止 | `git add`、`git commit`、`git push`、`git pull`、`git merge`、`git rebase`、`git reset`、`git checkout`（切换分支）、`git branch`（创建/删除分支）、`git tag`（创建/删除标签）等 |
| 文件系统修改类 | ❌ 禁止 | ❌ 禁止 | `mkdir`、`rmdir`、`rm`、`mv`、`cp`（复制到项目外）、`touch`、`chmod`、`chown`、`ln`、`unlink` 等 |
| 包管理器类 | ❌ 禁止 | ❌ 禁止 | `npm install`、`npm uninstall`、`npm update`、`yarn add`、`yarn remove`、`pip install`、`pip uninstall`、`composer install`、`composer update` 等 |
| 构建和部署类 | ❌ 禁止 | ❌ 禁止 | `npm run build`（如果会修改文件）、`make`（如果会修改文件）、`docker build`、`docker push` 等 |
| 环境配置类 | ❌ 禁止 | ❌ 禁止 | `export`（持久化）、`setenv`、修改 `.bashrc`、`.zshrc` 等配置文件 |

### 3.3 需要确认

#### 文件修改工具（Act 模式需要确认）

| 工具 | 确认条件 | 说明 |
|------|---------|------|
| `search_replace` | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 修改现有文件前必须满足所有确认条件 |
| `write` | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 创建新文件前必须满足所有确认条件 |
| `delete_file` | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 删除文件前必须满足所有确认条件 |
| `edit_notebook` | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 编辑笔记本前必须满足所有确认条件 |

#### 方案完整性要求

**必须包含的 5 个部分**：

1. **需求分析**：问题描述或用户需求、要解决的核心问题、需求背景（可选）
2. **修改方案**：修改的文件列表、修改的位置、具体的修改内容
3. **影响分析**：对现有功能的影响、对相关文件的影响、是否需要向下兼容（可选）
4. **实施计划**：任务清单（表格格式）、实施顺序、注意事项（可选）
5. **风险评估**：潜在问题（至少 1 个）、回滚方案（至少说明如何回滚）

**确认流程**：

1. 用户描述需求或问题
2. AI 输出完整方案（5 个部分）
3. 用户输入 "Act" 指令
4. AI 切换到 Act 模式并执行修改

---

## 四、行为权限分类

### 4.1 可以做

#### Plan 模式允许的行为

- ✅ **分析需求**：分析用户需求，理解要解决的问题
- ✅ **输出方案**：输出详细的修改方案（5 个部分）
- ✅ **输出计划**：输出任务清单和实施计划
- ✅ **搜索代码**：搜索代码库，查找相关代码
- ✅ **读取文件**：读取文件内容，分析代码结构
- ✅ **查看错误**：查看 Linter 错误（仅查看，不自动修复）
- ✅ **创建 TODO**：创建 TODO 列表记录计划任务
- ✅ **添加调试代码**：添加临时调试代码用于问题定位（需标记为临时）

#### Act 模式允许的行为

- ✅ **执行修改**：按照方案执行代码修改
- ✅ **创建文件**：创建新文件（需方案完整且用户确认）
- ✅ **修改文件**：修改现有文件（需方案完整且用户确认）
- ✅ **删除文件**：删除文件（需方案完整且用户确认）
- ✅ **清理调试代码**：清理临时调试代码

#### Debug 模式允许的行为

- ✅ **规则检查**：检查规则遵循情况
- ✅ **规则漏洞检查**：检查规则本身是否存在漏洞
- ✅ **提示词归档**：提炼归档提示词
- ✅ **会话管理**：管理会话上下文和会话ID

### 4.2 不可以做

#### Plan 模式禁止的行为

- ❌ **创建 TODO 后立即执行代码修改**：即使创建了 TODO 列表，也不能立即执行代码修改
- ❌ **假设用户同意执行**：不能假设用户同意执行，必须明确等待用户输入 "Act"
- ❌ **跳过 "Act" 指令直接执行修改**：只有用户明确输入 "Act" 指令才能切换到执行模式
- ❌ **在 Plan 模式下调用文件修改工具**：禁止调用 `search_replace`、`write`、`delete_file`、`edit_notebook` 等文件修改工具
- ❌ **运行可能改变代码库的命令**：禁止运行可能修改文件系统、Git 仓库、包管理器状态、环境配置的命令
- ❌ **将问题描述误判为纯询问，直接执行修改**：必须先确认用户意图，再决定是否输出方案
- ❌ **假设用户描述问题就是要求修改，跳过方案输出**：必须先输出方案，等待用户确认后才能执行
- ❌ **在未明确用户意图时，直接执行代码修改**：如果用户意图不明确，必须先询问确认
- ❌ **未输出方案就调用工具**：如果用户有修改需求，必须先输出方案，才能调用任何工具
- ❌ **将调试代码作为永久修复方案**：调试代码只能用于问题定位，不能作为永久修复方案
- ❌ **在未定位问题的情况下添加防御性代码**：必须先定位问题，再根据定位结果添加必要的修复代码

#### Act 模式禁止的行为

- ❌ **在 Act 模式下但方案不完整时执行修改**：如果方案不完整，必须停止执行并返回 Plan 模式补充方案
- ❌ **跳过方案输出直接调用文件修改工具**：必须先输出完整方案，才能执行修改
- ❌ **继续执行，忽略发现的问题**：如果执行过程中发现方案有问题，必须立即停止
- ❌ **不说明问题，直接修正**：必须明确说明发现的问题和修正方案
- ❌ **不返回 Plan 模式，在 Act 模式下直接修正方案**：如果方案有问题，必须返回 Plan 模式输出修正方案

#### 通用禁止行为

- ❌ **收到修改需求后直接执行代码修改**：必须先输出方案，等待用户确认
- ❌ **收到问题描述（可能涉及代码修改）后直接执行代码修改**：必须先确认用户意图，再决定是否输出方案
- ❌ **只输出简单计划就执行修改**：必须输出完整的 5 部分方案（需求分析、修改方案、影响分析、实施计划、风险评估）
- ❌ **假设用户同意执行（即使输出了方案）**：必须等待用户明确输入 "Act" 指令
- ❌ **跳过方案输出直接执行修改**：必须先输出方案，才能执行修改
- ❌ **假设用户意图，直接执行修改**：如果用户意图不明确，必须先询问确认
- ❌ **跳过确认，直接输出方案**：如果用户意图不明确，必须先确认再输出方案
- ❌ **使用模糊表述询问用户**：必须使用清晰、明确的问题表述
- ❌ **在用户未明确回复时，继续执行修改**：必须等待用户明确回复后再继续

### 4.3 需要确认

#### 需要用户确认的行为

| 行为 | 确认条件 | 说明 |
|------|---------|------|
| **执行代码修改** | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 所有代码修改都需要用户明确确认 |
| **创建新文件** | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 创建新文件需要用户明确确认 |
| **删除文件** | 1. 方案完整（5 个部分）<br>2. 用户输入 "Act" 指令 | 删除文件需要用户明确确认 |
| **技术方案调整** | 1. 识别调整影响<br>2. 明确询问兼容性需求<br>3. 等待用户明确回复 | 涉及 API 接口、数据结构、配置项等调整时需要确认兼容性 |
| **开放性问题** | 1. 识别开放性问题<br>2. 明确询问用户<br>3. 等待用户明确回复 | 存在多个可能方案或理解方式的问题需要确认 |
| **意图不明确** | 1. 识别意图不明确的情况<br>2. 明确询问用户意图<br>3. 等待用户明确回复 | 用户描述模糊或意图不明确时需要确认 |

#### 确认流程

1. **识别需要确认的情况**：分析用户需求，判断是否需要确认
2. **明确询问用户**：使用清晰、明确的问题表述，提供明确的选项
3. **等待用户回复**：必须等待用户明确回复后再继续
4. **根据回复决定下一步**：根据用户回复决定是否执行或如何执行

---

## 五、安全检查机制

### 工具调用前的统一检查机制

**检查时机**：在调用任何工具前必须执行此检查机制

**检查步骤**（按顺序执行，不能跳过任何步骤）：

#### 第零步：方案输出前置检查

- **检查条件**：如果用户有修改需求（明确要求修改、描述问题可能涉及修改、功能需求需要实现等）
- **检查内容**：
  - 是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
  - 是否已输出任务清单（使用表格格式）
- **检查结果**：
  - 如果用户有修改需求但未输出方案：**禁止调用任何工具**，必须先输出方案
  - 如果用户没有修改需求：进入第一步（模式检查）
  - 如果已输出方案：进入第一步（模式检查）

#### 第一步：模式检查

- 确认当前主模式（Plan 或 Act）
- **注意**：只检查 Plan/Act 模式，不检查 Debug 模式（Debug 模式不影响工具调用权限）
- 如果当前是 Plan 模式，进入第二步
- 如果当前是 Act 模式，进入第三步

#### 第二步：Plan 模式检查

- 检查工具类型（是否为禁止的工具）
- **禁止的工具清单**（Plan 模式）：
  - `search_replace`（修改文件）
  - `write`（创建或修改文件）
  - `delete_file`（删除文件）
  - `edit_notebook`（编辑笔记本）
  - `run_terminal_cmd`（运行可能改变代码库的命令）
- **检查结果**：
  - 如果是禁止的工具：**禁止调用**，立即停止并提醒用户需要切换到 Act 模式
  - 如果是允许的工具：可以调用

#### 第三步：Act 模式检查

- 检查是否为文件修改工具（`search_replace`、`write`、`delete_file`、`edit_notebook`）
- 如果是文件修改工具，进入第四步（方案完整性检查）
- 如果不是文件修改工具，可以调用

#### 第四步：方案完整性检查（仅针对文件修改工具）

- 检查是否已输出完整方案（包含需求分析、修改方案、影响分析、实施计划、风险评估 5 个部分）
- 检查是否已输出任务清单（使用表格格式）
- 检查用户是否已输入 "Act" 指令
- **检查结果**：
  - 如果方案不完整：停止执行并返回 Plan 模式补充方案
  - 如果方案完整：可以调用

### 检查清单

调用工具前必须逐项检查：

- [ ] 如果用户有修改需求，已检查是否已输出完整方案（第零步）
- [ ] 已确认当前主模式（Plan 或 Act，不考虑 Debug 模式）
- [ ] 已确认要调用的工具类型
- [ ] 如果是 Plan 模式，已检查是否为禁止的工具
- [ ] 如果是 Act 模式且是文件修改工具，已检查方案完整性
- [ ] 已确认满足所有检查条件

### 禁止的行为

- ❌ 在 Plan 模式下调用文件修改工具
- ❌ 在 Act 模式下但方案不完整时执行修改
- ❌ 跳过检查直接调用工具
- ❌ 跳过任何检查步骤
- ❌ 未输出方案就调用工具（即使工具本身是允许的）

---

## 六、权限升级机制

### 从 Plan 模式到 Act 模式

#### 升级条件

1. **用户输入 "Act" 指令**（不区分大小写）
2. **方案完整性检查通过**：
   - 已输出完整方案（5 个部分）
   - 每个部分都有实际内容
   - 任务清单使用表格格式

#### 升级流程

1. **检测用户输入 "Act" 指令**
2. **检查方案完整性**：
   - 是否已输出方案（5 个部分）？
   - 方案是否完整（每个部分都有内容）？
3. **根据检查结果处理**：
   - **方案完整**：切换到 Act 模式
   - **方案不完整**：
     - 不切换到 Act 模式（保持在 Plan 模式）
     - 明确提醒："方案不完整，无法切换到执行模式。请先补充完整方案。"
     - 输出缺失的部分，补充完整方案
     - 等待用户再次输入 "Act"
   - **没有方案**：
     - 不切换到 Act 模式（保持在 Plan 模式）
     - 明确提醒："未检测到修改方案。请先描述您的需求，我将输出详细方案。"
     - 询问用户的具体需求
     - 输出完整方案后，等待用户再次输入 "Act"

#### 禁止的行为

- ❌ 用户输入 "Act" 时，如果方案不完整，不能切换到 Act 模式
- ❌ 用户直接输入 "Act"（没有先输出方案）时，不能切换到 Act 模式
- ❌ 不能假设用户同意执行，跳过方案完整性检查

### 从 Act 模式到 Plan 模式

#### 降级条件

1. **执行完成**：所有修改操作完成后，自动返回 Plan 模式
2. **发现方案问题**：执行过程中发现方案有问题，立即返回 Plan 模式
3. **用户要求新修改**：用户要求执行新的修改（与当前计划不同），返回 Plan 模式

#### 降级流程

1. **识别降级条件**：检测到执行完成、方案问题或新需求
2. **停止当前执行**：立即停止当前执行
3. **说明原因**：明确说明降级的原因
4. **切换到 Plan 模式**：切换到 Plan 模式
5. **输出方案**（如果需要）：如果是新需求，输出新需求的详细方案

---

## 适用场景

**以下场景必须遵循此规范：**

- ✅ **所有工具调用**：调用任何工具前都必须执行安全检查
- ✅ **所有代码修改**：所有代码修改都需要方案完整且用户确认
- ✅ **所有模式切换**：模式切换必须满足相应条件
- ✅ **所有需要确认的操作**：需要确认的操作必须等待用户明确回复

---

## 重要原则

1. **安全第一**：所有操作必须以安全为前提
2. **权限明确**：每个模式下的权限必须明确
3. **确认优先**：需要确认的操作必须等待用户明确确认
4. **检查强制**：所有工具调用前必须执行安全检查
5. **方案完整**：代码修改前必须输出完整方案
6. **用户确认**：所有修改操作都需要用户明确确认

---

## 注意事项

1. **强制要求**：所有操作必须遵循此规范，这是强制要求，不是建议
2. **规则关系**：本文件是对其他规则文件的整合和索引，详细规范请参考对应文件
3. **及时更新**：如果其他规则文件更新，应及时更新本文件
4. **一致性要求**：本文件与其他规则文件应保持一致，如有冲突以详细规则文件为准

